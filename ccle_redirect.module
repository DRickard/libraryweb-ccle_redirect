<?php

function ccle_redirect_menu() {
    $items = array();
    $items['redirect/ccle'] = array(
        'title' => 'CCLE Request Parameters',
        'page callback' => 'ccle_redirect_list',
        'page arguments' => array(1),
        'access arguments' => array('access content'),
        'type' => MENU_NORMAL_ITEM,
     );
    return $items;
}

function ccle_redirect_list() {

    $myvar0 = $_GET['c0']['t'];
    $myvar1 = $_GET['c0']['sub'];
    $myvar2 = $_GET['c0']['cat'];
    $myvar3 = $_GET['c0']['sec'];

    $myvar0 = str_replace(' ', '', $myvar0);
    $myvar1 = str_replace(' ', '', $myvar1);
    $myvar2 = str_replace(' ', '', $myvar2);
    $myvar3 = str_replace(' ', '', $myvar3);

    $myvar0 = str_replace('%20', '', $myvar0);
    $myvar1 = str_replace('%20', '', $myvar1);
    $myvar2 = str_replace('%20', '', $myvar2);
    $myvar3 = str_replace('%20', '', $myvar3);

//    krumo($_GET);
//    krumo($myvar0);


  $output = '';

  // Get all entries in the rc_res_rules table.
  if ($entries = ccle_redirect_entry_load($myvar1)) {
    $rows = array();
    foreach ($entries as $entry) {
//krumo($entry);
      // Sanitize the data before handing it off to the theme layer.
    $rows[] = array_map('check_plain', (array) $entry);
    }

$error_term = t('No Lib-Guides for this term have been added yet.'); // display on _menu page to user

$rd_class = '';
foreach ($rows as $row) {
// Sanitize the data before handing it off to the theme layer.
    if( $row['term'] == $myvar0 ){
        $error_term = '';
        if( count( $row['crsidx'] ) > 0 ){
            if( $row['crsidx'] == $myvar2 ){
                if( count( $row['classidx'] ) > 0 ){
                    if( $row['classidx'] == $myvar3 ){
                    $rd_class = $row['lib_guide'];
//                    drupal_goto($path = $row['lib_guide']);
                    }
                } else {
                    $rd_crs = $row['lib_guide'];
                }
            } else {
                $rd_subj = $row['lib_guide'];
            }
        } else {
            $rd_subj = $row['lib_guide'];
        }
    }
}


// cycle through redirect_subj, crs and class and branch accordingly



    // Make a table for them.
    $header = array(t('Pid'), t('term'), t('subj_area'), t('crsidx'), t('classidx'), t('lib_guide'));
    $output .= theme('table', array('header' => $header, 'rows' => $rows));
  } else {
        $error_no_guide = t('No Lib-Guides have been added yet.'); // display on _menu page to user
//    drupal_set_message(t('No Lib-Guides have been added yet.')); // display on _menu page to user
  }
  $output .= 'myVars = '.$myvar0.' '.$myvar1.' '.$myvar2.' '.$myvar3.' ';
  return $output;
}


/**
 * Read from the database using a filter array.
 *
 */
function ccle_redirect_entry_load($entry = array()) {
//    print_r("===>".$entry);
// Read all fields from the rc_res_rules table.
$query = db_select('ccle_redirect','u');
$query
->condition('u.subj_area',$entry,'=')
->fields('u',array('pid','term','subj_area','crsidx','classidx','lib_guide'))
->range(0,50);
$result=$query->execute();
//print_r($result);

//    while( $record = $result->fetchAssoc() ) {
//        print_r($record);
//    }


return $result;
}

//<?php
//    $result = db_select('node', 'n')
//    ->fields('n')
//    ->condition('nid', $node->nid,'=')
//    ->condition('status', 0,'>')
//    ->condition('uid', array(1,5,7),'IN')
//    ->execute()
//    ->fetchAssoc();
//?>
